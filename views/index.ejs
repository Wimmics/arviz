<!DOCTYPE html>
<html lang="en">

<head>
    <title>ARViz</title>
    <meta charset="UTF-8">

    <!-- tooltip -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <!-- js scripts -->
    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3-color.v2.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3-interpolate.v2.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/1.1.0/d3-legend.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- stylesheets -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css"/>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>

    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" media="all" />

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" />

    <!-- ARViz-related files -->
    <!-- CSS -->
    <link rel="stylesheet" href="/arviz/css/common.css">
    <link rel="stylesheet" href="/arviz/css/graph_viz.css">
    <link rel="stylesheet" href="/arviz/css/chordDiagram.css">

    <!-- libs -->
    <script type="text/javascript" src='/arviz/lib/FileSaver.js'></script>
    <script type="text/javascript" src="/arviz/lib/simple_statistics.js"></script>	
    <script type="text/javascript" src="/arviz/lib/dragscroll.js"></script>	

    <script type="text/javascript" src="/arviz/lib/d3-context-menu/d3-context-menu.js"></script>
    <link rel="stylesheet" href="/arviz/lib/d3-context-menu/d3-context-menu.css">
    <script type="text/javascript" src="/arviz/lib/d3-forkchord.js"></script>

    <!-- interface js -->
    <script type="text/javascript" src="/arviz/js/utils.js"></script>
    <script type="text/javascript" src="/arviz/js/autocomplete.js"></script>
    <script type="text/javascript" src="/arviz/js/contextmenu.js"></script>
    <script type="text/javascript" src="/arviz/js/querying.js"></script>
    <script type="text/javascript" src="/arviz/js/details_on_demand.js"></script>
    <script type="text/javascript" src="/arviz/js/configPanel.js"></script>
    <script type="text/javascript" src="/arviz/js/graphViz.js"></script>
    <script type="text/javascript" src="/arviz/js/chordDiagram.js"></script>
    <script type="text/javascript" src="/arviz/js/scatterPlot.js"></script> 
</head>

<body>
    <!-- left side buttons -- settings for the current data and visual tools -->
    <div class='menu-buttons' >
        <div class="menu-icon left-icon" id='legend_button'>
            <span><i class="fas fa-palette"></i></span>
        </div>
        <div class="menu-icon left-icon" id='data-filter_button'>
            <span><i class="fas fa-filter"></i></span>
        </div>
        <div class="menu-icon left-icon" id='data-sort_button'>
            <span><i class="fas fa-sort"></i></span>
        </div>
        <div class="menu-icon left-icon" style='top: 20px;' id='about'>
            <span><a href='javascript:void(0);' onclick="about()"><i class="fas fa-info-circle"></i></a></span>
        </div>
    </div>

    <!-- divs activated by the buttons above -->
    <div class='sideNav-bar' id='legend'></div>
    <div class='sideNav-bar' id='data-filter'></div>
    <div class='sideNav-bar' id='data-sort'></div>
    <div class='sideNav-bar' id='upload-file'></div>

    <div class='visu-space'>
        <!-- tabs that enable switching between views -->
        <div class="tab-bar" onclick="setScatterPlot();" id='scatterplot-tab'>Overview of Rules</div>
        <div class="tab-bar" onclick="setChordDiagramView();" id='chord-tab'>Circular Paginated View of Subsets</div>
        <div class="tab-bar" onclick="setGraphView();" id='graph-tab'>Exploratory Graph View of Items</div>

        <!-- the div that will contain the views -->
        <div class='viewContainer'></div>
        
        <!-- the forms below are only enabled for the association graph view -->
        <div class='forms'>
            <div class='left' id='antecedentSide'>
                <div class='text-div'>Search by</div> 
                <form autocomplete="off" onsubmit="handleInput(event)">
                    <div class="autocomplete">
                        <input id="antecedentInput" type="text" name="source" placeholder="Antecedent">
                        <input type="submit" value="Go">
                    </div>
                </form>  
            </div>
            <div class='right' id='consequentSide'>
                <div class='text-div'>Search by</div> 
                <form autocomplete="off" onsubmit="handleInput(event)">
                    <div class="autocomplete">
                        <input id="consequentInput" type="text" name="target" placeholder="Consequent">
                        <input type="submit" value="Go">
                    </div>
                </form>  
            </div>
        </div>
        
        <!-- the forms below are enabled together with the circular view -->
        <div class="options">
            <div class="rotationValueNav"></div>
            <div class='bottom-button'>
                <button onclick="setGraphView('all', null)">Display all terms</button>
            </div>
        </div>

    </div>

    <script>
        const locals = <%- JSON.stringify(locals) %>;
        const data = <%- JSON.stringify(data) %>;
        let filteredData;

        // chord diagram nodes' settings
        const cd = {
            'visibleNodes': 40,
            'firstNode': 0,
            'lastNode': 40,
            'data': null,
            'browsing': 'rules'
        };

        const graph = {direction: null, 
            currentTerm: null,
            activeTerms: null}

        let height, width, activeChart = null;

        window.addEventListener('load', async (event) => {
            // const response = await fetch('/arviz/' + locals.appli + '/data')
            // data = await response.json()
            // console.log(data)

            data.rules = data.rules.filter(d => locals.appli === 'issa' ? d.lang !== 'fr' : true)

            await getLabelsURI()

            let symmetricItems = data.rules.filter(d => d.isSymmetric)
        
    
            let validItems = []
            symmetricItems.forEach((d,i) => {
                if (!validItems.some(e => (e.antecedents.equals(d.consequents) && e.consequents.equals(d.antecedents)) || (e.antecedents.equals(d.antecedents) && e.consequents.equals(d.consequents))))
                    validItems.push(d)
            })
            
            data.rules = data.rules.filter((d,i) => d.isSymmetric ? validItems.some(e => e.antecedents.equals(d.antecedents) && e.consequents.equals(d.consequents)) : true)

            const tooltip = d3.select('body').append('div')
                .classed('tooltip', true)

            // set page 
            const div = d3.select('div.viewContainer')
            width = div.node().clientWidth
            height = div.node().clientHeight

            // set menu buttons interaction
            d3.selectAll('div.menu-icon')
                .filter(function() { return this.id != 'about'; })
                .on('click', openNav)
                .on('mouseenter', showSideButtonTooltip)
                .on('mouseleave', hideTooltip)

            cd['maxNodes'] = data.length,

            // legend
            setColors()
            setLegends()

            // filtering and sorting panels
            setFilteringCriteria()
            setSortPanel()
            setFilterPanel()
            setInfoTooltip()
            updateFilteringKeys()

            filteredData = getFilteredData(); // this variable keeps the filtered data used in both charts, commonly updated
            updateSearchForms()

            setGraphView('all', null)

        })

        // handle the submit action from the graph view's forms
        function handleInput(event){
            event.preventDefault();
            if (event.submitter.nodeName == 'BUTTON') return;
            let type = event.srcElement[0].name;
            let value = document.getElementById(event.srcElement[0].id).value;
            setGraphView(type, value)

            if (type == 'source') document.getElementById('consequentInput').value = '';
            else document.getElementById('antecedentInput').value = '';
        }       
        
        function about(event) {
            window.open('/arviz/' + locals.appli + '/about')
        }
        
    </script>

    
      

</body>
</html>